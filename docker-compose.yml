# docker-compose.yml - Encrypted Forest local dev environment
#
# Services:
#   - arx-node-1..3: Arcium ARX MPC nodes (main cluster)
#   - arx-node-4: Extra node (registered on-chain for recovery, not in cluster)
#   - arcium-trusted-dealer: Key distribution for DKG
#
# NOTE: Surfpool runs natively (no Docker image available).
#       Start it with: ./scripts/dev-start.sh
#       This compose file provides the ARX node infrastructure that connects
#       to Surfpool's RPC at host.docker.internal:8899.
#
# Network:
#   Custom bridge network "arcium-net" with subnet 172.20.0.0/16
#   Main cluster nodes:     172.20.0.100 - 172.20.0.103
#   Trusted Dealer:         172.20.0.99
#
# Usage:
#   docker compose up -d       # Start ARX nodes
#   docker compose down        # Stop everything

services:
  # ---------------------------------------------------------------------------
  # Arcium Trusted Dealer
  # ---------------------------------------------------------------------------
  arcium-trusted-dealer:
    image: arcium/trusted-dealer:latest
    container_name: ef-trusted-dealer
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./arx-keys/trusted-dealer/trusted_dealer_config.toml
        target: /usr/trusted-dealer/trusted_dealer_config.toml
        read_only: false
      - type: bind
        source: ./arx-keys/trusted-dealer/td_identity.pem
        target: /usr/trusted-dealer/identity.json
      - type: bind
        source: ./arx-keys/trusted-dealer/td_master_seed.json
        target: /usr/trusted-dealer/master_seed.json
      - ./logs/trusted-dealer:/usr/trusted-dealer/logs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      arcium-net:
        ipv4_address: 172.20.0.99

  # ---------------------------------------------------------------------------
  # ARX Node 1 (Main Cluster)
  # ---------------------------------------------------------------------------
  arx-node-1:
    image: arcium/arx-node:latest
    container_name: ef-arx-node-1
    restart: unless-stopped
    environment:
      NODE_IDENTITY_FILE: /usr/arx-node/node-keys/node_identity.pem
      NODE_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      OPERATOR_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      CALLBACK_AUTHORITY_KEYPAIR_FILE: /usr/arx-node/node-keys/callback_authority_keypair.json
      NODE_CONFIG_PATH: /usr/arx-node/arx/node_config.toml
      BLS_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/bls_keypair.json
      X25519_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/x25519_keypair.json
      ARX_METRICS_HOST: "0.0.0.0"
    ports:
      - "127.0.0.1:9091:9091"
    volumes:
      - type: bind
        source: ./arx-keys/node-1/node-config.toml
        target: /usr/arx-node/arx/node_config.toml
        read_only: false
      - type: bind
        source: ./arx-keys/node-1/node-keypair.json
        target: /usr/arx-node/node-keys/node_keypair.json
      - type: bind
        source: ./arx-keys/node-1/node-keypair.json
        target: /usr/arx-node/node-keys/operator_keypair.json
      - type: bind
        source: ./arx-keys/node-1/callback-kp.json
        target: /usr/arx-node/node-keys/callback_authority_keypair.json
      - type: bind
        source: ./arx-keys/node-1/identity.pem
        target: /usr/arx-node/node-keys/node_identity.pem
      - ./logs/arx-node-1:/usr/arx-node/logs
      - type: bind
        source: ./arx-keys/node-1/bls-keypair.json
        target: /usr/arx-node/node-keys/bls_keypair.json
      - type: bind
        source: ./arx-keys/node-1/x25519-keypair.json
        target: /usr/arx-node/node-keys/x25519_keypair.json
      - type: bind
        source: ./arx-keys/node-1/private-shares
        target: /usr/arx-node/private-shares
      - type: bind
        source: ./arx-keys/node-1/public-inputs
        target: /usr/arx-node/public-inputs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      arcium-net:
        ipv4_address: 172.20.0.100

  # ---------------------------------------------------------------------------
  # ARX Node 2 (Main Cluster)
  # ---------------------------------------------------------------------------
  arx-node-2:
    image: arcium/arx-node:latest
    container_name: ef-arx-node-2
    restart: unless-stopped
    environment:
      NODE_IDENTITY_FILE: /usr/arx-node/node-keys/node_identity.pem
      NODE_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      OPERATOR_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      CALLBACK_AUTHORITY_KEYPAIR_FILE: /usr/arx-node/node-keys/callback_authority_keypair.json
      NODE_CONFIG_PATH: /usr/arx-node/arx/node_config.toml
      BLS_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/bls_keypair.json
      X25519_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/x25519_keypair.json
      ARX_METRICS_HOST: "0.0.0.0"
    ports:
      - "127.0.0.1:9092:9091"
    volumes:
      - type: bind
        source: ./arx-keys/node-2/node-config.toml
        target: /usr/arx-node/arx/node_config.toml
        read_only: false
      - type: bind
        source: ./arx-keys/node-2/node-keypair.json
        target: /usr/arx-node/node-keys/node_keypair.json
      - type: bind
        source: ./arx-keys/node-2/node-keypair.json
        target: /usr/arx-node/node-keys/operator_keypair.json
      - type: bind
        source: ./arx-keys/node-2/callback-kp.json
        target: /usr/arx-node/node-keys/callback_authority_keypair.json
      - type: bind
        source: ./arx-keys/node-2/identity.pem
        target: /usr/arx-node/node-keys/node_identity.pem
      - ./logs/arx-node-2:/usr/arx-node/logs
      - type: bind
        source: ./arx-keys/node-2/bls-keypair.json
        target: /usr/arx-node/node-keys/bls_keypair.json
      - type: bind
        source: ./arx-keys/node-2/x25519-keypair.json
        target: /usr/arx-node/node-keys/x25519_keypair.json
      - type: bind
        source: ./arx-keys/node-2/private-shares
        target: /usr/arx-node/private-shares
      - type: bind
        source: ./arx-keys/node-2/public-inputs
        target: /usr/arx-node/public-inputs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      arcium-net:
        ipv4_address: 172.20.0.101

  # ---------------------------------------------------------------------------
  # ARX Node 3 (Main Cluster)
  # ---------------------------------------------------------------------------
  arx-node-3:
    image: arcium/arx-node:latest
    container_name: ef-arx-node-3
    restart: unless-stopped
    environment:
      NODE_IDENTITY_FILE: /usr/arx-node/node-keys/node_identity.pem
      NODE_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      OPERATOR_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      CALLBACK_AUTHORITY_KEYPAIR_FILE: /usr/arx-node/node-keys/callback_authority_keypair.json
      NODE_CONFIG_PATH: /usr/arx-node/arx/node_config.toml
      BLS_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/bls_keypair.json
      X25519_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/x25519_keypair.json
      ARX_METRICS_HOST: "0.0.0.0"
    ports:
      - "127.0.0.1:9093:9091"
    volumes:
      - type: bind
        source: ./arx-keys/node-3/node-config.toml
        target: /usr/arx-node/arx/node_config.toml
        read_only: false
      - type: bind
        source: ./arx-keys/node-3/node-keypair.json
        target: /usr/arx-node/node-keys/node_keypair.json
      - type: bind
        source: ./arx-keys/node-3/node-keypair.json
        target: /usr/arx-node/node-keys/operator_keypair.json
      - type: bind
        source: ./arx-keys/node-3/callback-kp.json
        target: /usr/arx-node/node-keys/callback_authority_keypair.json
      - type: bind
        source: ./arx-keys/node-3/identity.pem
        target: /usr/arx-node/node-keys/node_identity.pem
      - ./logs/arx-node-3:/usr/arx-node/logs
      - type: bind
        source: ./arx-keys/node-3/bls-keypair.json
        target: /usr/arx-node/node-keys/bls_keypair.json
      - type: bind
        source: ./arx-keys/node-3/x25519-keypair.json
        target: /usr/arx-node/node-keys/x25519_keypair.json
      - type: bind
        source: ./arx-keys/node-3/private-shares
        target: /usr/arx-node/private-shares
      - type: bind
        source: ./arx-keys/node-3/public-inputs
        target: /usr/arx-node/public-inputs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      arcium-net:
        ipv4_address: 172.20.0.102

  # ---------------------------------------------------------------------------
  # ARX Node 4 (Extra â€” registered on-chain for recovery, not in main cluster)
  # ---------------------------------------------------------------------------
  arx-node-4:
    image: arcium/arx-node:latest
    container_name: ef-arx-node-4
    restart: unless-stopped
    environment:
      NODE_IDENTITY_FILE: /usr/arx-node/node-keys/node_identity.pem
      NODE_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      OPERATOR_KEYPAIR_FILE: /usr/arx-node/node-keys/node_keypair.json
      CALLBACK_AUTHORITY_KEYPAIR_FILE: /usr/arx-node/node-keys/callback_authority_keypair.json
      NODE_CONFIG_PATH: /usr/arx-node/arx/node_config.toml
      BLS_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/bls_keypair.json
      X25519_PRIVATE_KEY_FILE: /usr/arx-node/node-keys/x25519_keypair.json
      ARX_METRICS_HOST: "0.0.0.0"
    ports:
      - "127.0.0.1:9094:9091"
    volumes:
      - type: bind
        source: ./arx-keys/node-4/node-config.toml
        target: /usr/arx-node/arx/node_config.toml
        read_only: false
      - type: bind
        source: ./arx-keys/node-4/node-keypair.json
        target: /usr/arx-node/node-keys/node_keypair.json
      - type: bind
        source: ./arx-keys/node-4/node-keypair.json
        target: /usr/arx-node/node-keys/operator_keypair.json
      - type: bind
        source: ./arx-keys/node-4/callback-kp.json
        target: /usr/arx-node/node-keys/callback_authority_keypair.json
      - type: bind
        source: ./arx-keys/node-4/identity.pem
        target: /usr/arx-node/node-keys/node_identity.pem
      - ./logs/arx-node-4:/usr/arx-node/logs
      - type: bind
        source: ./arx-keys/node-4/bls-keypair.json
        target: /usr/arx-node/node-keys/bls_keypair.json
      - type: bind
        source: ./arx-keys/node-4/x25519-keypair.json
        target: /usr/arx-node/node-keys/x25519_keypair.json
      - type: bind
        source: ./arx-keys/node-4/private-shares
        target: /usr/arx-node/private-shares
      - type: bind
        source: ./arx-keys/node-4/public-inputs
        target: /usr/arx-node/public-inputs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      arcium-net:
        ipv4_address: 172.20.0.103

networks:
  arcium-net:
    ipam:
      config:
        - subnet: 172.20.0.0/16
